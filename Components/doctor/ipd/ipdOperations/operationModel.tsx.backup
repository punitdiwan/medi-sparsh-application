"use client";

import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Operation } from "./ipdOperationManager";
import { PlusCircle, Users2, X } from "lucide-react";
import { getOperationCategories } from "@/lib/actions/operationCategories";
import { getOperationsByCategory, createIPDOperation } from "@/lib/actions/operations";
import { getDoctors } from "@/lib/actions/doctorActions";
import { useEffect, useState } from "react";
import { toast } from "sonner";
import { MultiSelect } from "./multi-select";

/* ---------------- Schema ---------------- */
const operationSchema = z.object({
  categoryId: z.string().min(1),
  category: z.string().min(1),
  operationId: z.string().min(1),
  name: z.string().min(1),
  date: z.string().min(1),
  time: z.string().min(1),
  doctors: z.array(z.string()).min(1, "Please select at least one doctor"),
  assistant1: z.string().optional(),
  assistant2: z.string().optional(),
  anesthetist: z.string().optional(),
  anesthesiaType: z.string().optional(),
  technician: z.string().optional(),
  otAssistant: z.string().optional(),
  remark: z.string().optional(),
  result: z.string().optional(),
});

type OperationFormValues = z.infer<typeof operationSchema>;

type Props = {
  open: boolean;
  ipdAdmissionId: string;
  onClose: () => void;
  onSubmit: () => void;
  defaultValues?: Partial<Operation>;
};

/* ---------------- Component ---------------- */
export function IPDOperationDialog({ open, ipdAdmissionId, onClose, onSubmit, defaultValues }: Props) {
  const [categories, setCategories] = useState<{ id: string; name: string }[]>([]);
  const [operations, setOperations] = useState<{ id: string; name: string }[]>([]);
  const [doctors, setDoctors] = useState<{ id: string; name: string }[]>([]);

  const form = useForm<OperationFormValues>({
    resolver: zodResolver(operationSchema),
    defaultValues: {
      categoryId: "",
      category: "",
      operationId: "",
      name: "",
      date: new Date().toISOString().split('T')[0],
      time: "",
      doctors: [],
      ...defaultValues,
    },
  });

  const categoryId = form.watch("categoryId");

  useEffect(() => {
    const fetchInitialData = async () => {
      const catRes = await getOperationCategories();
      if (catRes.data) setCategories(catRes.data as any);

      const docRes = await getDoctors();
      if (docRes.data) setDoctors(docRes.data as any);
    };
    fetchInitialData();
  }, []);

  useEffect(() => {
    if (categoryId) {
      const fetchOperations = async () => {
        const opRes = await getOperationsByCategory(categoryId);
        if (opRes.data) setOperations(opRes.data as any);
      };
      fetchOperations();
    } else {
      setOperations([]);
    }
  }, [categoryId]);

  const handleSubmit = async (data: OperationFormValues) => {
    const supportStaffJson = {
      assistant1: data.assistant1 || "",
      assistant2: data.assistant2 || "",
      technician: data.technician || "",
      otAssistant: data.otAssistant || "",
    };

    const anaesthetistJson = {
      name: data.anesthetist || "",
    };

    const operationDetails = `Remarks: ${data.remark || ""}\nResult: ${data.result || ""}`;

    // Combine date and time into a Date object
    const [year, month, day] = data.date.split("-").map(Number);
    const [hours, minutes] = data.time.split(":").map(Number);
    const opDate = new Date(year, month - 1, day, hours, minutes);

    const res = await createIPDOperation({
      ipdAdmissionId,
      operationId: data.operationId,
      operationDate: opDate,
      operationTime: opDate,
      doctors: data.doctors,
      anaesthetist: anaesthetistJson,
      anaesthetiaType: data.anesthesiaType || "",
      operationDetails,
      supportStaff: supportStaffJson,
    });

    if (res.data) {
      toast.success("Operation saved successfully");
      onSubmit();
    } else {
      toast.error(res.error || "Failed to save operation");
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-xl rounded-xl border border-dialog bg-dialog-surface p-0 overflow-hidden shadow-lg flex flex-col">

        {/* HEADER */}
        <DialogHeader className="px-6 py-4 bg-dialog-header border-b border-dialog flex flex-row justify-between items-center sticky top-0 z-10">
          <div className="flex items-center gap-3">
            <div className="flex items-center justify-center rounded-lg">
              <Users2 className="bg-dialog-header text-dialog-icon" />
            </div>
            <DialogTitle className="text-lg font-semibold tracking-wide">
              {defaultValues ? "Edit Operation" : "Add Operation"}
            </DialogTitle>
          </div>

          {/* CROSS BUTTON */}
          <Button
            variant="ghost"
            className="text-white hover:bg-white/20 rounded-full p-1"
            onClick={onClose}
          >
            <X className="h-4 w-4" />
          </Button>
        </DialogHeader>

        {/* SCROLLABLE BODY */}
        <div className="px-6 py-5 space-y-4 overflow-y-auto max-h-[70vh] bg-dialog-surface text-dialog">
          <div className="grid grid-cols-2 gap-4">

            {/* Category */}
            <SelectField
              label="Operation Category *"
              value={categoryId}
              onValueChange={(v: string) => {
                const cat = categories.find(c => c.id === v);
                form.setValue("categoryId", v);
                form.setValue("category", cat?.name || "");
                form.setValue("operationId", "");
                form.setValue("name", "");
              }}
              options={categories.map(c => ({ label: c.name, value: c.id }))}
            />

            {/* Operation Name */}
            <SelectField
              label="Operation Name *"
              value={form.watch("operationId")}
              onValueChange={(v: string) => {
                const op = operations.find(o => o.id === v);
                form.setValue("operationId", v);
                form.setValue("name", op?.name || "");
              }}
              options={operations.map(op => ({ label: op.name, value: op.id }))}
              disabled={!categoryId}
            />

            {/* Date */}
            <InputField label="Operation Date *" type="date" {...form.register("date")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />

            {/* Time */}
            <InputField label="Operation Time *" type="time" {...form.register("time")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />

            {/* Consultant Doctor */}
            <SelectField
              label="Consultant Doctor *"
              value={form.watch("doctors")}
              onValueChange={(v: string) => form.setValue("doctors", v)}
              options={doctors.map(d => ({ label: d.name, value: d.name }))}
            />

            {/* <MultiSelect
              options={options}
              onValueChange={setSelectedValues}
              defaultValue={selectedValues}
            /> */}

            {/* Assistants / Anesthetist / Technician */}
            <InputField label="Assistant Consultant 1" {...form.register("assistant1")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="Assistant Consultant 2" {...form.register("assistant2")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="Anesthetist" {...form.register("anesthetist")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="Anesthesia Type" {...form.register("anesthesiaType")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="OT Technician" {...form.register("technician")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="OT Assistant" {...form.register("otAssistant")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="Remark" {...form.register("remark")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />
            <InputField label="Result" {...form.register("result")} className="bg-dialog-input border-dialog-input text-dialog focus-visible:ring-primary" />

          </div>
        </div>

        {/* FOOTER */}
        <DialogFooter className="px-6 py-4 bg-dialog-header border-t border-dialog text-dialog-muted flex justify-end gap-2 sticky bottom-0 z-10">
          <Button variant="outline" type="button" onClick={onClose} className="text-dialog-muted">Cancel</Button>
          <Button type="submit" onClick={form.handleSubmit(handleSubmit)} className="flex items-center gap-2 bg-dialog-primary text-dialog-btn hover:bg-btn-hover hover:opacity-90">
            <PlusCircle className="h-4 w-4" />
            {defaultValues ? "Update Operation" : "Save Operation"}
          </Button>
        </DialogFooter>

      </DialogContent>
    </Dialog>
  );
}

/* ---------------- Helper Components ---------------- */
function InputField({ label, ...props }: { label: string } & any) {
  return (
    <div className="flex flex-col gap-1 w-full">
      <Label>{label}</Label>
      <Input {...props} />
    </div>
  );
}

function SelectField({ label, options, value, onValueChange, disabled }: {
  label: string;
  options: { label: string; value: string }[];
  value: string;
  onValueChange: (v: string) => void;
  disabled?: boolean;
}) {
  return (
    <div className="flex flex-col gap-1 w-full">
      <Label>{label}</Label>
      <Select value={value} onValueChange={onValueChange} disabled={disabled}>
        <SelectTrigger className="w-full bg-dialog-input border-dialog-input text-dialog">
          <SelectValue placeholder={`Select ${label}`} />
        </SelectTrigger>
        <SelectContent>
          {options.map((opt) => (
            <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
}


